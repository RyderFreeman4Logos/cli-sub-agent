[workflow]
name = "mktd"
description = "Make TODO: CSA-powered reconnaissance, adversarial debate, and structured TODO plan generation"

[[workflow.variables]]
name = "CWD"

[[workflow.variables]]
name = "FEATURE"

[[workflow.variables]]
name = "USER_LANGUAGE"
description = "Primary language for TODO content (auto-detected from conversation or FEATURE description; e.g. 'Chinese (Simplified)', 'English', 'Japanese')"

[[workflow.steps]]
id = 0
title = "Phase 0.5 — Auto Session Discovery"
tool = "bash"
prompt = """
Find a reusable mktd session for the current project/branch.
Rules:
- Match branch + task_type=plan + phase=Available
- If found, output only the most recent session_id
- If not found (or not in git/detached HEAD), output empty string

```bash
command -v python3 >/dev/null 2>&1 || { echo ""; exit 0; }
python3 - <<'PY'
import json
import subprocess
import sys

def run(cmd):
    return subprocess.check_output(cmd, text=True).strip()

try:
    branch = run(["git", "rev-parse", "--abbrev-ref", "HEAD"])
except Exception:
    print("")
    sys.exit(0)

if not branch or branch == "HEAD":
    print("")
    sys.exit(0)

try:
    output = run(["csa", "session", "list", "--branch", branch, "--format", "json"])
    sessions = json.loads(output)
except Exception:
    print("")
    sys.exit(0)

for session in sessions:
    if session.get("task_type") == "plan" and session.get("phase") == "Available":
        print(session.get("session_id", ""))
        break
else:
    print("")
PY
```"""
on_fail = "abort"

[[workflow.steps]]
id = 50
title = "Phase 1.5 — Language Detection"
tool = "bash"
prompt = """
Resolve planning language for TODO content.
Priority:
1) Explicit ${USER_LANGUAGE}
2) Environment ${CSA_USER_LANGUAGE}
3) Detect from ${FEATURE}
4) Fallback to English

```bash
if [[ -n "${USER_LANGUAGE:-}" ]]; then
  printf '%s\n' "${USER_LANGUAGE}"
  exit 0
fi
if [[ -n "${CSA_USER_LANGUAGE:-}" ]]; then
  printf '%s\n' "${CSA_USER_LANGUAGE}"
  exit 0
fi
if printf '%s' "${FEATURE:-}" | rg -q '[\\p{Han}]'; then
  echo "Chinese (Simplified)"
  exit 0
fi
if printf '%s' "${FEATURE:-}" | rg -q '[\\p{Hiragana}\\p{Katakana}]'; then
  echo "Japanese"
  exit 0
fi
echo "English"
```"""
on_fail = "abort"

[[workflow.steps]]
id = 1
title = "Phase 1 — RECON Dimension 1 (Structure)"
tool = "csa"
session = "${STEP_0_OUTPUT}"
prompt = """
Analyze codebase structure relevant to ${FEATURE}.
Report: relevant files (path + purpose, max 20), key types, module dependencies, entry points.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 2
title = "Phase 1 — RECON Dimension 2 (Patterns)"
tool = "csa"
session = "${STEP_0_OUTPUT}"
prompt = """
Find existing patterns or similar features to ${FEATURE} in this codebase.
Report: file paths with approach, reusable components, conventions to follow.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 3
title = "Phase 1 — RECON Dimension 3 (Constraints)"
tool = "csa"
session = "${STEP_0_OUTPUT}"
prompt = """
Identify constraints and risks for implementing ${FEATURE}.
Report: potential breaking changes, security considerations, performance, compatibility.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 4
title = "Phase 2 — DRAFT TODO"
prompt = """
Synthesize CSA findings into a structured TODO plan.

## RECON Findings (from prior steps)

### Structure (Step 1)
${STEP_1_OUTPUT}

### Patterns (Step 2)
${STEP_2_OUTPUT}

### Constraints (Step 3)
${STEP_3_OUTPUT}

## Instructions
Each item is a [ ] checkbox with executor tag.
Write all TODO descriptions, section headers, and task names in ${STEP_50_OUTPUT}.
Technical terms, code snippets, commit scope strings, and executor tags remain in English.
Pre-assign executors: [Main], [Sub:developer], [Skill:commit], [CSA:tool].
Every checkbox item MUST include a mechanically verifiable DONE WHEN line.

## Output
Output the COMPLETE TODO plan as text to stdout.
Do NOT write files to the project directory.
The output will be captured as ${STEP_4_OUTPUT} for subsequent steps."""
on_fail = "abort"

[[workflow.steps]]
id = 5
title = "Phase 2.5 — Threat Model"
prompt = """
Review the draft TODO plan for security and safety concerns.

## Draft TODO Plan
${STEP_4_OUTPUT}

## Instructions
For each new API surface in the plan (config fields, CLI inputs, stored data,
external interactions), enumerate:
- What sensitive data flows through this path?
- What happens with malformed/hostile input?
- What information is exposed in logs/display/persistence?
- What default behavior is safe vs unsafe?

Output a structured threat analysis. Each finding should specify:
1. **Surface** — what is being introduced
2. **Risk** — what could go wrong
3. **Mitigation** — how the TODO should address it

These findings will be incorporated into the TODO as [Security] tagged items."""
on_fail = "abort"

[[workflow.steps]]
id = 6
title = "Phase 3 — Adversarial Debate"
tool = "bash"
prompt = """
Run explicit adversarial debate via `csa debate`.
Capture debate stdout, then normalize into a structured evidence packet
for mechanical validation in Step 6.5.

```bash
LANGUAGE="${STEP_50_OUTPUT:-English}"
DEBATE_PROMPT="$(printf '%s\n' \
"Critically evaluate this draft TODO plan and threat model. Act as a devil's advocate." \
"" \
"## Draft TODO Plan" \
"${STEP_4_OUTPUT}" \
"" \
"## Threat Model (Step 5)" \
"${STEP_5_OUTPUT}" \
"" \
"## Output Requirements" \
"Provide explicit verdict and confidence in your conclusion." )"
DEBATE_SUMMARY="$(printf '%s\n' "${DEBATE_PROMPT}" | csa debate --rounds 3)" || { echo "csa debate failed" >&2; exit 1; }
[[ -n "${DEBATE_SUMMARY:-}" ]] || { echo "empty debate summary" >&2; exit 1; }
RAW_VERDICT="$(printf '%s\n' "${DEBATE_SUMMARY}" | grep '^Debate verdict:' | tail -n1 | sed -nE 's/^Debate verdict:[[:space:]]*([A-Z]+).*/\\1/p')"
case "${RAW_VERDICT}" in
  APPROVE) MAPPED_VERDICT="READY" ;;
  REVISE|REJECT) MAPPED_VERDICT="REVISE" ;;
  *) MAPPED_VERDICT="REVISE" ;;
esac
CONFIDENCE="$(printf '%s\n' "${DEBATE_SUMMARY}" | grep '^Debate verdict:' | tail -n1 | sed -nE 's/^Debate verdict:[^\\(]*\\(confidence:[[:space:]]*([a-zA-Z]+)\\).*/\\1/p')"
printf '%s\n' "DEBATE_EVIDENCE:"
printf '%s\n' "- method: csa debate"
printf '%s\n' "- rounds: 3"
printf '%s\n' "- language: ${LANGUAGE}"
printf '%s\n' "- raw_verdict: ${RAW_VERDICT:-UNKNOWN}"
printf '%s\n' "- mapped_verdict: ${MAPPED_VERDICT}"
printf '%s\n' "- confidence: ${CONFIDENCE:-unknown}"
printf '%s\n' "VALID_CONCERNS:"
printf '%s\n' "- Review debate summary + threat model findings before approval."
printf '%s\n' "SUGGESTED_CHANGES:"
if [ "${MAPPED_VERDICT}" = "REVISE" ]; then
  printf '%s\n' "- Revise TODO tasks based on debate objections and risk findings."
else
  printf '%s\n' "- Keep current plan; no blocking objections detected by debate."
fi
printf '%s\n' "OVERALL_ASSESSMENT:"
printf '%s\n' "${DEBATE_SUMMARY}"
```"""
on_fail = "abort"

[[workflow.steps]]
id = 61
title = "Phase 3.5 — Validate Debate Evidence"
tool = "bash"
prompt = """
Validate that debate output exists and carries required evidence markers.

```bash
[[ -n "${STEP_6_OUTPUT:-}" ]] || { echo "STEP_6_OUTPUT is empty — debate did not run" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" | grep -q '^DEBATE_EVIDENCE:' || { echo "debate evidence header missing" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" | grep -Eq 'mapped_verdict:[[:space:]]*(READY|REVISE)' || { echo "mapped debate verdict missing" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" | grep -Eq 'raw_verdict:[[:space:]]*(APPROVE|REVISE|REJECT|UNKNOWN)' || { echo "raw debate verdict missing" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" | grep -Eq 'confidence:[[:space:]]*(high|medium|low|unknown)' || { echo "debate confidence missing" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" | grep -q '^VALID_CONCERNS:' || { echo "valid concerns section missing" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" | grep -q '^SUGGESTED_CHANGES:' || { echo "suggested changes section missing" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" | grep -q '^OVERALL_ASSESSMENT:' || { echo "overall assessment section missing" >&2; exit 1; }
```"""
on_fail = "abort"

[[workflow.steps]]
id = 7
title = "Revise TODO"
prompt = """
Incorporate debate feedback and threat model findings into the TODO plan.
Concede valid points and revise accordingly. Defend sound decisions with evidence.

## Prior Context

### Draft TODO (Step 4)
${STEP_4_OUTPUT}

### Threat Model (Step 5)
${STEP_5_OUTPUT}

### Adversarial Critique (Step 6)
${STEP_6_OUTPUT}

## Output
Output the COMPLETE revised TODO plan as text to stdout.
Include threat model findings as [Security] tagged checkbox items.
Do NOT write files to the project directory.
The output will be captured as ${STEP_7_OUTPUT} for the save step."""
on_fail = "abort"

[[workflow.steps]]
id = 8
title = "Save TODO"
tool = "bash"
prompt = """
Save finalized TODO using csa todo for git-tracked lifecycle.
Uses ${STEP_7_OUTPUT} (the revised TODO from the revise step).
Execute ONLY the command block below.
FORBIDDEN: custom shell snippets, heredoc (`<<EOF`, `cat <<`), branch create/switch,
and writing intermediate files outside the TODO path.

```bash
[[ -n "${STEP_7_OUTPUT:-}" ]] || { echo "STEP_7_OUTPUT is empty — Step 7 (revise) must output the finalized TODO as text" >&2; exit 1; }
printf '%s\n' "${STEP_7_OUTPUT}" | grep -qE '^- \\[ \\] .+' || { echo "STEP_7_OUTPUT has no non-empty checkbox tasks" >&2; exit 1; }
printf '%s\n' "${STEP_7_OUTPUT}" | grep -q 'DONE WHEN:' || { echo "STEP_7_OUTPUT has no DONE WHEN clauses" >&2; exit 1; }
RESOLVED_LANGUAGE="${STEP_50_OUTPUT:-English}"
if printf '%s' "${RESOLVED_LANGUAGE}" | grep -qi 'chinese'; then
  HAN_COUNT_DRAFT=$(printf '%s\n' "${STEP_7_OUTPUT}" | rg -o '[\\p{Han}]' | wc -l | tr -d '[:space:]')
  [[ "${HAN_COUNT_DRAFT:-0}" -ge 30 ]] || { echo "STEP_7_OUTPUT language mismatch: expected Chinese content" >&2; exit 1; }
fi
CURRENT_BRANCH=$(git branch --show-current) || { echo "detect branch failed" >&2; exit 1; }
TODO_TS=$(csa todo create --branch "${CURRENT_BRANCH}" -- "${FEATURE}") || { echo "csa todo create failed" >&2; exit 1; }
TODO_PATH=$(csa todo show -t "${TODO_TS}" --path) || { echo "csa todo show failed" >&2; exit 1; }
printf '%s\n' "${STEP_7_OUTPUT}" > "${TODO_PATH}" || { echo "write TODO failed" >&2; exit 1; }
[[ -s "${TODO_PATH}" ]] || { echo "saved TODO is empty" >&2; exit 1; }
grep -qE '^- \\[ \\] .+' "${TODO_PATH}" || { echo "saved TODO has no non-empty checkbox tasks" >&2; exit 1; }
grep -q 'DONE WHEN:' "${TODO_PATH}" || { echo "saved TODO has no DONE WHEN clauses" >&2; exit 1; }
if printf '%s' "${RESOLVED_LANGUAGE}" | grep -qi 'chinese'; then
  HAN_COUNT_SAVED=$(rg -o '[\\p{Han}]' "${TODO_PATH}" | wc -l | tr -d '[:space:]')
  [[ "${HAN_COUNT_SAVED:-0}" -ge 30 ]] || { echo "saved TODO language mismatch: expected Chinese content" >&2; exit 1; }
fi
csa todo save -t "${TODO_TS}" "finalize: ${FEATURE}"
csa todo show -t "${TODO_TS}" --path
```"""
on_fail = "abort"

[[workflow.steps]]
id = 9
title = "Phase 4 — User Approval"
prompt = """
Present TODO to user for review in ${STEP_50_OUTPUT}.
User chooses: APPROVE → proceed to mktsk, MODIFY → revise, REJECT → abandon."""
on_fail = "abort"
