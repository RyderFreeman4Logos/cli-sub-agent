[workflow]
name = "mktd"
description = "Make TODO: CSA-powered reconnaissance, adversarial debate, and structured TODO plan generation"

[[workflow.variables]]
name = "CWD"

[[workflow.variables]]
name = "FEATURE"

[[workflow.variables]]
name = "USER_LANGUAGE"
description = "Primary language for TODO content (auto-detected from conversation or FEATURE description; e.g. 'Chinese (Simplified)', 'English', 'Japanese')"

[[workflow.steps]]
id = 0
title = "Phase 0.5 — Auto Session Discovery"
tool = "bash"
prompt = """
Find a reusable mktd session for the current project/branch.
Rules:
- Match branch + task_type=plan + phase=Available
- If found, output only the most recent session_id
- If not found (or not in git/detached HEAD), output empty string

```bash
command -v python3 >/dev/null 2>&1 || { echo ""; exit 0; }
python3 - <<'PY'
import json
import subprocess
import sys

def run(cmd):
    return subprocess.check_output(cmd, text=True).strip()

try:
    branch = run(["git", "rev-parse", "--abbrev-ref", "HEAD"])
except Exception:
    print("")
    sys.exit(0)

if not branch or branch == "HEAD":
    print("")
    sys.exit(0)

try:
    output = run(["csa", "session", "list", "--branch", branch, "--format", "json"])
    sessions = json.loads(output)
except Exception:
    print("")
    sys.exit(0)

for session in sessions:
    if session.get("task_type") == "plan" and session.get("phase") == "Available":
        print(session.get("session_id", ""))
        break
else:
    print("")
PY
```"""
on_fail = "abort"

[[workflow.steps]]
id = 1
title = "Phase 1 — RECON Dimension 1 (Structure)"
tool = "csa"
session = "${STEP_0_OUTPUT}"
prompt = """
Analyze codebase structure relevant to ${FEATURE}.
Report: relevant files (path + purpose, max 20), key types, module dependencies, entry points.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 2
title = "Phase 1 — RECON Dimension 2 (Patterns)"
tool = "csa"
session = "${STEP_0_OUTPUT}"
prompt = """
Find existing patterns or similar features to ${FEATURE} in this codebase.
Report: file paths with approach, reusable components, conventions to follow.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 3
title = "Phase 1 — RECON Dimension 3 (Constraints)"
tool = "csa"
session = "${STEP_0_OUTPUT}"
prompt = """
Identify constraints and risks for implementing ${FEATURE}.
Report: potential breaking changes, security considerations, performance, compatibility.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 4
title = "Phase 2 — DRAFT TODO"
prompt = """
Synthesize CSA findings into a structured TODO plan.

## RECON Findings (from prior steps)

### Structure (Step 1)
${STEP_1_OUTPUT}

### Patterns (Step 2)
${STEP_2_OUTPUT}

### Constraints (Step 3)
${STEP_3_OUTPUT}

## Instructions
Each item is a [ ] checkbox with executor tag.
Write all TODO descriptions, section headers, and task names in ${USER_LANGUAGE}.
Technical terms, code snippets, commit scope strings, and executor tags remain in English.
If USER_LANGUAGE is empty or unset, default to the language used in the FEATURE description.
Pre-assign executors: [Main], [Sub:developer], [Skill:commit], [CSA:tool].

## Output
Output the COMPLETE TODO plan as text to stdout.
Do NOT write files to the project directory.
The output will be captured as ${STEP_4_OUTPUT} for subsequent steps."""
on_fail = "abort"

[[workflow.steps]]
id = 5
title = "Phase 3 — Adversarial Debate"
tool = "csa"
prompt = """
Critically evaluate this draft TODO plan. Act as a devil's advocate.

## Draft TODO Plan
${STEP_4_OUTPUT}

## Instructions
Challenge assumptions, identify gaps, question priorities, and suggest improvements.
Focus on:
- Missing dependencies or prerequisites
- Incorrect task ordering
- Unrealistic scope or missing edge cases
- Security risks not addressed
- Tasks that should be split or combined

Output a structured critique:
1. **Valid Concerns** — issues that MUST be addressed
2. **Suggested Changes** — concrete improvements
3. **Overall Assessment** — is the plan ready or needs revision?"""
tier = "tier-2-standard"
on_fail = "abort"

[[workflow.steps]]
id = 6
title = "Revise TODO"
prompt = """
Incorporate debate feedback into the TODO plan.
Concede valid points and revise accordingly. Defend sound decisions with evidence.

## Prior Context

### Draft TODO (Step 4)
${STEP_4_OUTPUT}

### Adversarial Critique (Step 5)
${STEP_5_OUTPUT}

## Output
Output the COMPLETE revised TODO plan as text to stdout.
Do NOT write files to the project directory.
The output will be captured as ${STEP_6_OUTPUT} for the save step."""
on_fail = "abort"

[[workflow.steps]]
id = 7
title = "Save TODO"
tool = "bash"
prompt = """
Save finalized TODO using csa todo for git-tracked lifecycle.
Uses ${STEP_6_OUTPUT} (the revised TODO from the revise step).

```bash
[[ -n "${STEP_6_OUTPUT:-}" ]] || { echo "STEP_6_OUTPUT is empty — Step 6 (revise) must output the finalized TODO as text" >&2; exit 1; }
TODO_TS=$(csa todo create --branch "$(git branch --show-current)" -- "${FEATURE}") || { echo "csa todo create failed" >&2; exit 1; }
TODO_PATH=$(csa todo show -t "${TODO_TS}" --path) || { echo "csa todo show failed" >&2; exit 1; }
printf '%s\n' "${STEP_6_OUTPUT}" > "${TODO_PATH}" || { echo "write TODO failed" >&2; exit 1; }
csa todo save -t "${TODO_TS}" "finalize: ${FEATURE}"
```"""
on_fail = "abort"

[[workflow.steps]]
id = 8
title = "Phase 4 — User Approval"
prompt = """
Present TODO to user for review in ${USER_LANGUAGE}.
User chooses: APPROVE → proceed to mktsk, MODIFY → revise, REJECT → abandon."""
on_fail = "abort"
