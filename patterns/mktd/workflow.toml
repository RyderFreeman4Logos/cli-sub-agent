[workflow]
name = "mktd"
description = "Make TODO: CSA-powered reconnaissance, adversarial debate, and structured TODO plan generation"

[[workflow.variables]]
name = "CWD"

[[workflow.variables]]
name = "FEATURE"

[[workflow.variables]]
name = "FINALIZED_TODO_CONTENT"

[[workflow.variables]]
name = "USER_LANGUAGE"
description = "Primary language for TODO content (auto-detected from conversation or FEATURE description; e.g. 'Chinese (Simplified)', 'English', 'Japanese')"

[[workflow.steps]]
id = 1
title = "Phase 1 — RECON Dimension 1 (Structure)"
tool = "csa"
prompt = """
Analyze codebase structure relevant to ${FEATURE}.
Report: relevant files (path + purpose, max 20), key types, module dependencies, entry points.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 2
title = "Phase 1 — RECON Dimension 2 (Patterns)"
tool = "csa"
prompt = """
Find existing patterns or similar features to ${FEATURE} in this codebase.
Report: file paths with approach, reusable components, conventions to follow.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 3
title = "Phase 1 — RECON Dimension 3 (Constraints)"
tool = "csa"
prompt = """
Identify constraints and risks for implementing ${FEATURE}.
Report: potential breaking changes, security considerations, performance, compatibility.
Working directory: ${CWD}"""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 4
title = "Phase 2 — DRAFT TODO"
prompt = """
Synthesize CSA findings into a structured TODO plan.

## RECON Findings (from prior steps)

### Structure (Step 1)
${STEP_1_OUTPUT}

### Patterns (Step 2)
${STEP_2_OUTPUT}

### Constraints (Step 3)
${STEP_3_OUTPUT}

## Instructions
Each item is a [ ] checkbox with executor tag.
Write all TODO descriptions, section headers, and task names in ${USER_LANGUAGE}.
Technical terms, code snippets, commit scope strings, and executor tags remain in English.
If USER_LANGUAGE is empty or unset, default to the language used in the FEATURE description.
Pre-assign executors: [Main], [Sub:developer], [Skill:commit], [CSA:tool]."""
on_fail = "abort"

[[workflow.steps]]
id = 5
title = "Phase 3 — Adversarial Debate"
tool = "csa"
prompt = ""
tier = "tier-2-standard"
on_fail = "abort"

[[workflow.steps]]
id = 6
title = "Include debate"
tool = "weave"
prompt = "debate"
on_fail = "abort"

[[workflow.steps]]
id = 7
title = "Revise TODO"
prompt = """
Incorporate debate feedback. Update plan based on valid criticisms.
Concede valid points, defend sound decisions with evidence.

## Prior Context

### Draft TODO (Step 4)
${STEP_4_OUTPUT}

### Adversarial Debate (Step 5)
${STEP_5_OUTPUT}

### Debate Include (Step 6)
${STEP_6_OUTPUT}"""
on_fail = "abort"

[[workflow.steps]]
id = 8
title = "Save TODO"
tool = "bash"
prompt = """
Save finalized TODO using csa todo for git-tracked lifecycle.

```bash
[[ -n "${FINALIZED_TODO_CONTENT:-}" ]] || { echo "FINALIZED_TODO_CONTENT is empty — agent must produce content in Steps 4-6" >&2; exit 1; }
TODO_TS=$(csa todo create --branch "$(git branch --show-current)" -- "${FEATURE}") || { echo "csa todo create failed" >&2; exit 1; }
TODO_PATH=$(csa todo show -t "${TODO_TS}" --path) || { echo "csa todo show failed" >&2; exit 1; }
printf '%s\\n' "${FINALIZED_TODO_CONTENT}" > "${TODO_PATH}" || { echo "write TODO failed" >&2; exit 1; }
csa todo save -t "${TODO_TS}" "finalize: ${FEATURE}"
```"""
on_fail = "abort"

[[workflow.steps]]
id = 9
title = "Phase 4 — User Approval"
prompt = """
Present TODO to user for review in ${USER_LANGUAGE}.
User chooses: APPROVE → proceed to mktsk, MODIFY → revise, REJECT → abandon."""
on_fail = "abort"
