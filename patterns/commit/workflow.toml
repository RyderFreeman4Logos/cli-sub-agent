[workflow]
name = "commit"
description = "Strict commit discipline with Conventional Commits, mandatory security audit, test verification, and pre-commit review"

[[workflow.variables]]
name = "AUDIT_FAIL"

[[workflow.variables]]
name = "AUDIT_PASS_DEFERRED"

[[workflow.variables]]
name = "BRANCH"

[[workflow.variables]]
name = "COMMIT_MSG"

[[workflow.variables]]
name = "FILES"

[[workflow.variables]]
name = "HAS_DEFERRED_ISSUES"

[[workflow.variables]]
name = "IS_MILESTONE"

[[workflow.variables]]
name = "PR_BODY"

[[workflow.variables]]
name = "REVIEW_HAS_ISSUES"

[[workflow.variables]]
name = "SCOPE"

[[workflow.steps]]
id = 1
title = "Branch Check"
tool = "bash"
prompt = """
Verify not on protected branch. Must be on feature branch.

```bash
default_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
if [ -z "$default_branch" ]; then default_branch="main"; fi
branch=$(git branch --show-current)
if [ "$branch" = "$default_branch" ] || [ "$branch" = "dev" ]; then
  echo "ERROR: Cannot commit directly to $branch. Create a feature branch."
  exit 1
fi
```"""
on_fail = "abort"

[[workflow.steps]]
id = 2
title = "Run Formatters"
tool = "bash"
prompt = """
```bash
just fmt
```"""

[workflow.steps.on_fail]
retry = 2

[[workflow.steps]]
id = 3
title = "Run Linters"
tool = "bash"
prompt = """
```bash
just clippy
```"""

[workflow.steps.on_fail]
retry = 2

[[workflow.steps]]
id = 4
title = "Run Tests"
tool = "bash"
prompt = """
```bash
just test
```"""
on_fail = "abort"

[[workflow.steps]]
id = 5
title = "Stage Changes"
tool = "bash"
prompt = """
Stage all relevant files. Verify no untracked files remain.

```bash
git add ${FILES}
if git ls-files --others --exclude-standard | grep -q .; then
  echo "ERROR: Untracked files detected."
  git ls-files --others --exclude-standard
  exit 1
fi
```"""
on_fail = "abort"

[[workflow.steps]]
id = 6
title = "Security Scan"
tool = "bash"
prompt = """
Check staged files for hardcoded secrets, debug statements.

```bash
git diff --cached --name-only | while read -r file; do
  if grep -nE '(API_KEY|SECRET|PASSWORD|PRIVATE_KEY)=' "$file" 2>/dev/null; then
    echo "FAIL: Potential secret in $file"
    exit 1
  fi
done
```"""
on_fail = "abort"

[[workflow.steps]]
id = 7
title = "Security Audit"
tool = "csa"
prompt = """
Perform a three-phase security audit on the staged changes.
Run 'git diff --staged' yourself to see all changes.

Phase 1 — Test Completeness: For each public function in changed files,
verify tests exist for normal path, edge cases, and error paths.
Phase 2 — Vulnerability Scan: Check for injection, hardcoded secrets,
unsafe patterns, missing input validation, panic-prone code on untrusted input.
Phase 3 — Code Quality: No debug code, proper error handling, no commented-out code.

Output: structured report with PASS/FAIL per phase. If any phase FAIL, list specific issues."""
tier = "tier-2-standard"
on_fail = "abort"

[[workflow.steps]]
id = 8
title = "Step 7a: Fix Audit Issues"
prompt = "Fix blocking issues and re-run from Step 2."
on_fail = "abort"
condition = "${AUDIT_FAIL}"

[[workflow.steps]]
id = 9
title = "Step 7b: Record Deferred Issues"
prompt = """
Record deferred issues (other modules) via TaskCreate for
immediate post-commit fixing."""
on_fail = "abort"
condition = "${AUDIT_PASS_DEFERRED}"

[[workflow.steps]]
id = 10
title = "Pre-Commit Review"
tool = "csa"
prompt = """
Review all staged changes for correctness, security, and code quality.
Run 'git diff --staged' yourself to see the full patch.

Check each modified file against its AGENTS.md rules (discover the chain from
repository root to the file's directory). Violations of MUST/CRITICAL rules are P1.

Output: structured review with issues categorized as P0 (blocking), P1 (must fix),
P2 (should fix). Set REVIEW_HAS_ISSUES if any P0/P1 issues found."""
tier = "tier-2-standard"
on_fail = "abort"

[[workflow.steps]]
id = 11
title = "Fix Review Issues"
tool = "csa"
prompt = """
Fix issues, re-run quality gates, re-review.

```bash
just pre-commit
```"""
tier = "tier-2-standard"
condition = "${REVIEW_HAS_ISSUES}"

[workflow.steps.on_fail]
retry = 3

[[workflow.steps]]
id = 12
title = "Generate Commit Message"
tool = "csa"
prompt = """
Run 'git diff --staged' and generate a Conventional Commits message.
Scope: ${SCOPE}. Output ONLY the commit message, nothing else."""
tier = "tier-1-quick"
on_fail = "abort"

[[workflow.steps]]
id = 13
title = "Commit"
tool = "bash"
prompt = """
```bash
git commit -m "${COMMIT_MSG}"
```"""
on_fail = "abort"

[[workflow.steps]]
id = 14
title = "Auto PR"
tool = "bash"
prompt = """
Push and create PR when feature complete, bug fixed, or refactor done.
Steps 14-15 are ATOMIC — do not stop after PR creation.

```bash
git push -u origin "${BRANCH}"
gh pr create --base main --title "${COMMIT_MSG}" --body "${PR_BODY}"
```"""
on_fail = "abort"
condition = "${IS_MILESTONE}"

[[workflow.steps]]
id = 15
title = "Invoke PR Codex Bot"
prompt = """
Trigger the pr-codex-bot workflow on the newly created PR:
1. Trigger @codex review on the PR
2. Poll for bot response (max 10 min timeout)
3. Classify and action each bot comment
4. Arbitrate false positives via debate
5. Fix real issues and re-trigger
6. Merge when all issues resolved"""
on_fail = "abort"
condition = "${IS_MILESTONE}"

[[workflow.steps]]
id = 16
title = "Fix Deferred Issues"
prompt = """
Fix deferred issues by priority (Critical > High > Medium).
Each fix goes through full commit workflow (Steps 1-10)."""
on_fail = "abort"
condition = "${HAS_DEFERRED_ISSUES}"
