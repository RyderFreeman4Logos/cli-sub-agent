[workflow]
name = "csa-review"
description = "CSA-driven code review with independent model selection, session isolation, and structured outputs"

[[workflow.variables]]
name = "FIX_PROMPT"

[[workflow.variables]]
name = "MODE_IS_REVIEW_AND_FIX"

[[workflow.variables]]
name = "REVIEW_PROMPT"

[[workflow.variables]]
name = "REVIEW_TOOL"

[[workflow.variables]]
name = "SCOPE"

[[workflow.variables]]
name = "SCOPE_IS_PRE_PR"

[[workflow.variables]]
name = "SESSION_ID"

[[workflow.steps]]
id = 1
title = "Role Detection"
prompt = """
Check initial prompt for "Use the csa-review skill" literal string.
If present → review agent mode (skip orchestration, execute review directly).
If invoked by user → orchestrator mode (follow steps below).
Review agents MUST NOT run csa commands (prevents recursion)."""
on_fail = "abort"

[[workflow.steps]]
id = 2
title = "Determine Review Tool"
tool = "bash"
prompt = """
Read review tool from config. Auto mode: claude-code caller → codex reviewer,
codex caller → claude-code reviewer.

```bash
csa config get review.tool 2>/dev/null || echo "auto"
```"""
on_fail = "abort"

[[workflow.steps]]
id = 3
title = "Auto-Detect TODO Plan"
tool = "bash"
prompt = """
For pre-PR reviews (scope main...HEAD), auto-detect the associated TODO plan.
FATAL if no TODO found — pre-PR reviews require alignment checking.

```bash
csa todo find --branch "$(git branch --show-current)"
```"""
on_fail = "abort"
condition = "${SCOPE_IS_PRE_PR}"

[[workflow.steps]]
id = 4
title = "Build Review Prompt"
prompt = """
Construct comprehensive review prompt. The review agent reads CLAUDE.md
and AGENTS.md autonomously — do NOT pre-read them here.

Review prompt instructs agent to:
1. Read project context (CLAUDE.md + AGENTS.md)
2. Collect diff for given scope
3. Three-pass review (discovery, evidence filtering, adversarial security)
4. AGENTS.md compliance checklist (root-to-leaf, all applicable rules), including:
   - Rule 027 `pattern-workflow-sync` when diff touches `PATTERN.md` or `workflow.toml`
   - Rust rule 015 `subprocess-lifecycle` when diff touches process spawning/lifecycle code
5. Generate $CSA_SESSION_DIR/reviewer-{N}/review-findings.json and
   $CSA_SESSION_DIR/reviewer-{N}/review-report.md
6. Parse `[project_profile: <value>]` metadata from the instruction and apply
   framework-aware review dimensions from `references/review-protocol.md`"""
on_fail = "abort"

[[workflow.steps]]
id = 5
title = "Execute Review via CSA"
tool = "csa"
prompt = """
Perform code review: ${SCOPE}.

${REVIEW_PROMPT}"""
tier = "tier-3-complex"
on_fail = "abort"

[[workflow.steps]]
id = 6
title = "Present Results"
prompt = """
Read and display $CSA_SESSION_DIR/reviewer-{N}/review-report.md and
$CSA_SESSION_DIR/reviewer-{N}/review-findings.json summary,
AGENTS.md checklist summary. Report CSA session ID for follow-up."""
on_fail = "abort"

[[workflow.steps]]
id = 7
title = "Fix Mode"
tool = "csa"
prompt = """
Fix all P0 and P1 issues from the review.
Generate $CSA_SESSION_DIR/reviewer-{N}/fix-summary.md and
$CSA_SESSION_DIR/reviewer-{N}/post-fix-review-findings.json.
Mark remaining P0/P1 as incomplete.

${FIX_PROMPT}"""
tier = "tier-3-complex"
on_fail = "abort"
condition = "${MODE_IS_REVIEW_AND_FIX}"

[[workflow.steps]]
id = 8
title = "Verification"
tool = "bash"
prompt = """
Optionally verify fixes pass quality gates.

```bash
just pre-commit
```"""
on_fail = "skip"
